name: 'Build Sample App'
description: 'Builds a sample app and optionally publishes to Artifactory and pushes to a Docker registry'
inputs:
  app-dir:
    description: 'relative path to the app directory'
    required: true
  mvn-build-commands:
    description: 'commands passed to \"mvnw" to build the app'
    required: false
    default: '-B clean verify'
  artifactory-publish:
    description: 'whether or not to publish to artifactory'
    required: false
    default: 'false'
  jf-server-id:
    description: 'JFrog server id'
    required: false
    default: 'github-spring-cloud'
  jf-artifactory-spring:
    description: 'encoded JFrog server id configuration'
    required: false
  jf-mvn-build-commands:
    description: 'commands passed to \"jfrog rt mvn\" to publish the app'
    required: false
    default: '-B clean install -DskipTests'
  artifactory-repo-deploy-snapshots:
    description: 'which Artifactory repo to publish snapshot versions to (the \"--repo-deploy-snapshots\" arg passed to \"jfrog rt mvn\")'
    required: false
    default: 'libs-snapshot-local'
  artifactory-repo-deploy-releases:
    description: 'which Artifactory repo to publish non-snapshot versions to (the \"--repo-deploy-releases\" arg passed to \"jfrog rt mvn\")'
    required: false
    default: 'libs-release-local'
  docker-push:
    description: 'whether or not to push docker image to docker hub'
    required: false
    default: 'false'
  docker-registry:
    description: 'docker registry'
    required: false
  docker-username:
    description: 'docker username'
    required: false
  docker-password:
    description: 'docker password'
    required: false
  docker-images:
    description: 'csv of docker images to push'
    required: false
  docker-images-override:
    description: 'csv of docker image tags to use when pushing (parallel array to docker-images)'
    required: false
  java-version:
    description: 'Java Version. Default is 8'
    required: false
    default: '8'
  gpg-passphrase:
    description: 'The passphrase of the gpg key to sign the artifacts with'
    required: false
  gpg-private-key:
    description: 'The gpg private key to sign the artifacts with'
    required: false

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v2

    - uses: actions/setup-java@v3
      with:
        distribution: 'liberica'
        java-version: '${{ inputs.java-version }}'
        cache: maven

    - uses: jvalkeal/setup-maven@v1
      with:
        maven-version: 3.8.9
        maven-mirror: 'https://dlcdn.apache.org/maven/maven-3/'

    - name: Maven build
      shell: bash
      env:
        MAVEN_GPG_PRIVATE_KEY: ${{ inputs.gpg-private-key }}
        MAVEN_GPG_PASSPHRASE: ${{ inputs.gpg-passphrase }}
      run: |
        if [ -n "$MAVEN_GPG_PRIVATE_KEY" ]; then
          echo "${MAVEN_GPG_PRIVATE_KEY}" > private.asc
          gpg --import --batch --no-tty private.asc
        fi
        ./mvnw ${{ inputs.mvn-build-commands }}
      working-directory: ${{ inputs.app-dir }}

    - uses: ./.github/actions/build-sample-app/artifactory-publish
      if: ${{ inputs.artifactory-publish == 'true' }}
      with:
        app-dir: ${{ inputs.app-dir }}
        jf-server-id: ${{ inputs.jf-server-id }}
        jf-artifactory-spring: ${{ inputs.jf-artifactory-spring }}
        jf-mvn-build-commands: ${{ inputs.jf-mvn-build-commands }}
        artifactory-repo-deploy-snapshots: ${{ inputs.artifactory-repo-deploy-snapshots }}
        artifactory-repo-deploy-releases: ${{ inputs.artifactory-repo-deploy-releases }}
        gpg-passphrase: ${{ inputs.gpg-passphrase }}
        gpg-private-key: ${{ inputs.gpg-private-key }}

    - uses: ./.github/actions/build-sample-app/docker-push
      if: ${{ inputs.docker-push == 'true' }}
      with:
        app-dir: ${{ inputs.app-dir }}
        docker-registry: ${{ inputs.docker-registry }}
        docker-username: ${{ inputs.docker-username }}
        docker-password: ${{ inputs.docker-password }}
        docker-images: ${{ inputs.docker-images }}
        docker-images-override: ${{ inputs.docker-images-override }}
