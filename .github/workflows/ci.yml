name: CI

on:
  workflow_dispatch:
  push:
    paths-ignore:
      - '.github/**'

jobs:
  user-clicks-per-region:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    name: CI Build (user-clicks-per-region-1.2.x)
    steps:
      - uses: actions/checkout@v2

      - uses: jvalkeal/setup-maven@v1
        with:
          maven-version: 3.8.4

      - uses: actions/setup-java@v2
        with:
          distribution: adopt
          java-version: 8
          cache: maven

      - uses: jfrog/setup-jfrog-cli@v1
        with:
          version: 1.46.4
        env:
          JF_ARTIFACTORY_SPRING: ${{ secrets.JF_ARTIFACTORY_SPRING }}

      - name: Configure JFrog Cli
        run: |
          jfrog rt mvnc \
          --server-id-resolve=repo.spring.io \
          --server-id-deploy=repo.spring.io \
          --repo-resolve-releases=libs-milestone \
          --repo-resolve-snapshots=libs-snapshot \
          --repo-deploy-releases=release \
          --repo-deploy-snapshots=snapshot
          echo JFROG_CLI_BUILD_NAME=spring-cloud-dataflow-samples >> $GITHUB_ENV
          echo JFROG_CLI_BUILD_NUMBER=$GITHUB_RUN_NUMBER >> $GITHUB_ENV

      - name: Login dockerhub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build
        run: ./mvnw clean install jib:dockerBuild -pl http-click-ingest,http-region-ingest,user-clicks-per-region-processor,log-user-clicks-per-region,http-clicks-and-region-ingest
        working-directory: multi-io-samples/kafka-streams/user-clicks-per-region-1.2.x

      - name: Publish to Artifactory
        run: |
          jfrog rt mvn clean install -U -B -DskipTests
          jfrog rt build-publish
        working-directory: multi-io-samples/kafka-streams/user-clicks-per-region-1.2.x

      - name: Push images to Docker
        env:
          TAG2: ${{ inputs.version }}
        shell: bash
        run: |
          docker push springcloudstream/multi-io-sample-http-click-ingest:1.2.0-SNAPSHOT
          docker push springcloudstream/multi-io-sample-http-region-ingest:1.2.0-SNAPSHOT
          docker push springcloudstream/multi-io-sample-http-clicks-and-region-ingest:1.2.0-SNAPSHOT
          docker push springcloudstream/multi-io-sample-user-clicks-per-region-processor:1.2.0-SNAPSHOT
          docker push springcloudstream/multi-io-sample-log-user-clicks-per-region:1.2.0-SNAPSHOT
        working-directory: multi-io-samples/kafka-streams/user-clicks-per-region-1.2.x
